#!/bin/sh

# Do in two steps to avoid overriding in case of failure

cat firmware.tmp.c | grep COMMPROTO | sed 's/^\s\+COMMPROTO: \(.*\)$/\1/' > serial-protocol.txt.tmp \
        && cat serial-protocol.txt.tmp > ../../serial-protocol.txt || exit 200

# Calc version for the protocol
V=$(sha1sum ../../serial-protocol.txt | head -c2)
echo "AVR Protocol Version: $V"

cat firmware.tmp.c | sed "s/AK_PROTOCOL_VERSION/0x$V/g" > firmware-f.tmp.c && mv firmware-f.tmp.c firmware.tmp.c

# Update TS files
echo "// This file is auto-generated by src/avr/maintain-protocol script! DON'T EDIT!\n\nexport const avrProtocolVersion = 0x$V;\n" > ../../src/jsclient/server/avr/protocol.ts

echo "export interface AvrData {" >> ../../src/jsclient/server/avr/protocol.ts
cat firmware.tmp.c | grep TS_PROTO_TYPE | sed 's/^\s\+TS_PROTO_TYPE: \(.*\)$/    \1/' >> ../../src/jsclient/server/avr/protocol.ts
echo "}\n" >> ../../src/jsclient/server/avr/protocol.ts

echo "export function asAvrData(vals: {[id: string]: number}): AvrData { return {" >> ../../src/jsclient/server/avr/protocol.ts
cat firmware.tmp.c | grep TS_PROTO_ASSIGN | sed 's/^\s\+TS_PROTO_ASSIGN: \(.*\)$/    \1/' >> ../../src/jsclient/server/avr/protocol.ts
echo "};}\n" >> ../../src/jsclient/server/avr/protocol.ts
